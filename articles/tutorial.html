<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Moran's Eigenvector Maps and related methods for the spatial multiscale analysis of ecological data • adespatial</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Moran's Eigenvector Maps and related methods for the spatial multiscale analysis of ecological data">
<meta property="og:description" content="adespatial">
<meta property="og:image" content="/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">adespatial</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.3-23</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/tutorial.html">Moran's Eigenvector Maps and related methods for the spatial multiscale analysis of ecological data</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/sdray/adespatial/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Moran’s Eigenvector Maps and related methods for
the spatial multiscale analysis of ecological data</h1>
                        <h4 data-toc-skip class="author">Stéphane
Dray</h4>
            
            <h4 data-toc-skip class="date">2024-01-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/sdray/adespatial/blob/HEAD/vignettes/tutorial.Rmd" class="external-link"><code>vignettes/tutorial.Rmd</code></a></small>
      <div class="hidden name"><code>tutorial.Rmd</code></div>

    </div>

    
    
<p>The package <code>adespatial</code> contains functions for the
multiscale analysis of spatial multivariate data. It implements some new
functions and reimplements existing functions that were available in
packages of the sedaR project hosted on R-Forge
(<code>spacemakeR</code>, <code>packfor</code>, <code>AEM</code>, etc.).
It can be seen as a bridge between packages dealing with multivariate
data (e.g., <code>ade4</code>, <span class="citation">Dray and Dufour
(<a href="#ref-Dray2007" role="doc-biblioref">2007</a>)</span>) and
packages that deals with spatial data (<code>sp</code>,
<code>spdep</code>). In <code>adespatial</code>, many methods consider
the spatial information as a spatial weighting matrix (SWM), object of
class <code>listw</code> provided by the <code>spdep</code> package (<a href="#diagram">Figure 1</a>). The SWM is defined as the Hadamard
product (element-wise product) of a connectivity matrix by a weighting
matrix. The binary connectivity matrix (spatial neighborhood, object of
class <code>nb</code>) defines the pairs of connected and unconnected
samples, while the weighting matrix allows weighting the connections,
for instance to define that the strength of the connection between two
samples decreases with the geographic distance.</p>
<p>Once SWM is defined, it can be used to build Moran’s Eigenvector Maps
(MEM, <span class="citation">Dray, Legendre, and Peres-Neto (<a href="#ref-Dray2006" role="doc-biblioref">2006</a>)</span>) that are
orthogonal vectors maximizing the spatial autocorrelation (measured by
Moran’s coefficient). These spatial predictors can be used in
multivariate statistical methods to provide spatially-explicit
multiscale tools <span class="citation">(<a href="#ref-Dray2012" role="doc-biblioref">Dray et al. 2012</a>)</span>. This document
provides a description of the main functionalities of the package.</p>
<br><div style="text-align:center">
<p><a name="diagram"></a>
<img src="adespatial.png" style="width:700px"><span style="color:blue">Figure 1: Schematic representation of the functioning
of the <code>adespatial</code> package. Classes are represented in pink
frames and functions in blue frames. Classes and functions provided by
<code>adespatial</code> are in bold. </span></p>
</div>
<p><br></p>
<p>To run the different analysis described, several packages are
required and are loaded:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://pbil.univ-lyon1.fr/ADE-4/" class="external-link">ade4</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sdray/adespatial" class="external-link">adespatial</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Registered S3 methods overwritten by 'adegraphics':</span></span>
<span><span class="co">##   method         from</span></span>
<span><span class="co">##   biplot.dudi    ade4</span></span>
<span><span class="co">##   kplot.foucart  ade4</span></span>
<span><span class="co">##   kplot.mcoa     ade4</span></span>
<span><span class="co">##   kplot.mfa      ade4</span></span>
<span><span class="co">##   kplot.pta      ade4</span></span>
<span><span class="co">##   kplot.sepan    ade4</span></span>
<span><span class="co">##   kplot.statis   ade4</span></span>
<span><span class="co">##   scatter.coa    ade4</span></span>
<span><span class="co">##   scatter.dudi   ade4</span></span>
<span><span class="co">##   scatter.nipals ade4</span></span>
<span><span class="co">##   scatter.pco    ade4</span></span>
<span><span class="co">##   score.acm      ade4</span></span>
<span><span class="co">##   score.mix      ade4</span></span>
<span><span class="co">##   score.pca      ade4</span></span>
<span><span class="co">##   screeplot.dudi ade4</span></span></code></pre>
<pre><code><span><span class="co">## Registered S3 method overwritten by 'spdep':</span></span>
<span><span class="co">##   method   from</span></span>
<span><span class="co">##   plot.mst ape</span></span></code></pre>
<pre><code><span><span class="co">## Registered S3 methods overwritten by 'adespatial':</span></span>
<span><span class="co">##   method             from       </span></span>
<span><span class="co">##   plot.multispati    adegraphics</span></span>
<span><span class="co">##   print.multispati   ade4       </span></span>
<span><span class="co">##   summary.multispati ade4</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'adespatial'</span></span></code></pre>
<pre><code><span><span class="co">## The following object is masked from 'package:ade4':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     multispati</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://pbil.univ-lyon1.fr/ADE-4/" class="external-link">adegraphics</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'adegraphics'</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:ade4':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     kplotsepan.coa, s.arrow, s.class, s.corcircle, s.distri, s.image,</span></span>
<span><span class="co">##     s.label, s.logo, s.match, s.traject, s.value, table.value,</span></span>
<span><span class="co">##     triangle.class</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spdep/" class="external-link">spdep</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: spData</span></span></code></pre>
<pre><code><span><span class="co">## To access larger datasets in this package, install the spDataLarge</span></span>
<span><span class="co">## package with: `install.packages('spDataLarge',</span></span>
<span><span class="co">## repos='https://nowosad.github.io/drat/', type='source')`</span></span></code></pre>
<pre><code><span><span class="co">## Loading required package: sf</span></span></code></pre>
<pre><code><span><span class="co">## Linking to GEOS 3.10.2, GDAL 3.4.1, PROJ 8.2.1; sf_use_s2() is TRUE</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'spdep'</span></span></code></pre>
<pre><code><span><span class="co">## The following object is masked from 'package:ade4':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     mstree</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/sp/" class="external-link">sp</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="the-mafragh-data-set">The Mafragh data set<a class="anchor" aria-label="anchor" href="#the-mafragh-data-set"></a>
</h2>
<p>The Mafragh data set is used to illustrate several methods. It is
available in the <code>ade4</code> package and stored as a
<code>list</code>:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"mafragh"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "list"</span></span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "xy"              "flo"             "neig"            "env"            </span></span>
<span><span class="co">##  [5] "partition"       "area"            "tre"             "traits"         </span></span>
<span><span class="co">##  [9] "nb"              "Spatial"         "spenames"        "Spatial.contour"</span></span></code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">$</span><span class="va">flo</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 97 56</span></span></code></pre>
<p>The <code>data.frame</code> <code>mafragh$flo</code> is a floristic
table that contains the abundance of 56 plant species in 97 sites in
Algeria. Names of species are listed in <code>mafragh$spenames</code>.
The geographic coordinates of the sites are given in
<code>mafragh$xy</code>.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">$</span><span class="va">env</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 'data.frame':    97 obs. of  11 variables:</span></span>
<span><span class="co">##  $ Clay        : num  0.73 0.75 0.74 0.23 0.73 0.72 0.52 0.42 0.74 0.53 ...</span></span>
<span><span class="co">##  $ Silt        : num  0.24 0.24 0.24 0.26 0.24 0.22 0.46 0.49 0.24 0.44 ...</span></span>
<span><span class="co">##  $ Sand        : num  0.03 0.02 0.02 0.49 0.03 0.03 0.02 0.08 0.02 0.04 ...</span></span>
<span><span class="co">##  $ K2O         : num  1.3 0.8 1.7 0.3 1.3 1.7 0.8 1.4 1.7 1.4 ...</span></span>
<span><span class="co">##  $ Mg++        : num  9.2 10.7 8.6 2 9.2 6 6 19.6 8.6 17 ...</span></span>
<span><span class="co">##  $ Na+/100g    : num  4.2 10.4 10.8 1.2 4.2 10.7 18.4 2.5 10.8 11.7 ...</span></span>
<span><span class="co">##  $ K+          : num  1.2 1.4 1.9 0.3 1.2 1.3 2.2 1.3 1.9 0.5 ...</span></span>
<span><span class="co">##  $ Conductivity: num  7.9 11.5 10.4 0.6 7.9 14.5 15.2 2.9 10.4 16.9 ...</span></span>
<span><span class="co">##  $ Retention   : num  41.8 42.4 41.4 22.3 41.8 42.7 37.4 35.4 41.4 38 ...</span></span>
<span><span class="co">##  $ Na+/l       : num  48.7 66 24 2.2 48.7 ...</span></span>
<span><span class="co">##  $ Elevation   : num  6 2 2 6 6 4 4 3 3 6 ...</span></span></code></pre>
<p>The <code>data.frame</code> <code>mafragh$env</code> contains 11
quantitative environmental variables. A map of the study area is also
available (<code>mafragh$Spatial.contour</code>) that can be used as a
background to display the sampling design:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mxy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">$</span><span class="va">xy</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">mxy</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.label.html" class="external-link">s.label</a></span><span class="op">(</span><span class="va">mxy</span>, ppoint.pch <span class="op">=</span> <span class="fl">15</span>, ppoint.col <span class="op">=</span> <span class="st">"darkseagreen4"</span>, Sp <span class="op">=</span> <span class="va">mafragh</span><span class="op">$</span><span class="va">Spatial.contour</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-4-1.png" width="384" style="display: block; margin: auto;"></p>
<p>A more detailed description of the data set is available at <a href="http://pbil.univ-lyon1.fr/R/pdf/pps053.pdf" class="external-link uri">http://pbil.univ-lyon1.fr/R/pdf/pps053.pdf</a> (in
French).</p>
<p>The functionalities of the <code>adegraphics</code> package <span class="citation">(<a href="#ref-Siberchicot2017" role="doc-biblioref">Siberchicot et al. 2017</a>)</span> can be used to
design simple thematic maps to represent data. For instance, it is
possible to represent the spatial distribution of two species using the
<code>s.Spatial</code> function applied on Voronoi polygons contained in
<code>mafragh$Spatial</code>:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mafragh</span><span class="op">$</span><span class="va">spenames</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">11</span><span class="op">)</span>, <span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##                   scientific code</span></span>
<span><span class="co">## Sp1         Arisarum vulgare Arvu</span></span>
<span><span class="co">## Sp11 Bolboschoenus maritimus Boma</span></span></code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fpalette</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"white"</span>, <span class="st">"darkseagreen2"</span>, <span class="st">"darkseagreen3"</span>, <span class="st">"palegreen4"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sp.flo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/SpatialPolygons.html" class="external-link">SpatialPolygonsDataFrame</a></span><span class="op">(</span>Sr <span class="op">=</span> <span class="va">mafragh</span><span class="op">$</span><span class="va">Spatial</span>, data <span class="op">=</span> <span class="va">mafragh</span><span class="op">$</span><span class="va">flo</span>, match.ID <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.Spatial.html" class="external-link">s.Spatial</a></span><span class="op">(</span><span class="va">sp.flo</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">11</span><span class="op">)</span><span class="op">]</span>, col <span class="op">=</span> <span class="fu">fpalette</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>, nclass <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-6-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="building-spatial-neighborhood">Building spatial neighborhood<a class="anchor" aria-label="anchor" href="#building-spatial-neighborhood"></a>
</h2>
<p>Spatial neighborhoods are managed in <code>spdep</code> as objects of
class <code>nb</code>. It corresponds to the notion of connectivity
matrices discussed in <span class="citation">Dray, Legendre, and
Peres-Neto (<a href="#ref-Dray2006" role="doc-biblioref">2006</a>)</span> and can be represented by an
unweighted graph. Various functions allow to create <code>nb</code>
objects from geographic coordinates of sites. We present different
alternatives according to the design of the sampling scheme.</p>
<div class="section level3">
<h3 id="surface-data">Surface data<a class="anchor" aria-label="anchor" href="#surface-data"></a>
</h3>
<p>The function <code>poly2nb</code> allows to define neighborhood when
the sampling sites are polygons and not points (two regions are
neighbors if they share a common boundary). The resulting object can be
plotted on a geographical map using the <code>s.Spatial</code> function
of the <code>adegraphics</code> package <span class="citation">(<a href="#ref-Siberchicot2017" role="doc-biblioref">Siberchicot et al.
2017</a>)</span>.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">$</span><span class="va">Spatial</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "SpatialPolygons"</span></span>
<span><span class="co">## attr(,"package")</span></span>
<span><span class="co">## [1] "sp"</span></span></code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nb.maf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html" class="external-link">poly2nb</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">$</span><span class="va">Spatial</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.Spatial.html" class="external-link">s.Spatial</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">$</span><span class="va">Spatial</span>, nb <span class="op">=</span> <span class="va">nb.maf</span>, plabel.cex <span class="op">=</span> <span class="fl">0</span>, pnb.edge.col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-7-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="regular-grid-and-transect">Regular grid and transect<a class="anchor" aria-label="anchor" href="#regular-grid-and-transect"></a>
</h3>
<p>If the sampling scheme is based on regular sampling (e.g., grid of 8
rows and 10 columns), spatial coordinates can be easily generated:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xygrid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, y <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.label.html" class="external-link">s.label</a></span><span class="op">(</span><span class="va">xygrid</span>, plabel.cex <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-8-1.png" width="700" style="display: block; margin: auto;"></p>
<p>For a regular grid, spatial neighborhood can be created with the
function <code>cell2nb</code>. Two types of neighborhood can be defined.
The <code>queen</code> specification considered horizontal, vertical and
diagonal edges whereas the <code>rook</code> specification considered
only horizontal and vertical edges:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nb2.q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/cell2nb.html" class="external-link">cell2nb</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">10</span>, type <span class="op">=</span> <span class="st">"queen"</span><span class="op">)</span></span>
<span><span class="va">nb2.r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/cell2nb.html" class="external-link">cell2nb</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">10</span>, type <span class="op">=</span> <span class="st">"rook"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.label.html" class="external-link">s.label</a></span><span class="op">(</span><span class="va">xygrid</span>, nb <span class="op">=</span> <span class="va">nb2.q</span>, plabel.cex <span class="op">=</span> <span class="fl">0</span>, main <span class="op">=</span> <span class="st">"Queen neighborhood"</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-9-1.png" width="700" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.label.html" class="external-link">s.label</a></span><span class="op">(</span><span class="va">xygrid</span>, nb <span class="op">=</span> <span class="va">nb2.r</span>, plabel.cex <span class="op">=</span> <span class="fl">0</span>, main <span class="op">=</span> <span class="st">"Rook neighborhood"</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-9-2.png" width="700" style="display: block; margin: auto;"></p>
<p>The function <code>cell2nb</code> is the easiest way to deal with
transects by considering a grid with only one row:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xytransect</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">nb3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/cell2nb.html" class="external-link">cell2nb</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">nb3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 20 </span></span>
<span><span class="co">## Number of nonzero links: 38 </span></span>
<span><span class="co">## Percentage nonzero weights: 9.5 </span></span>
<span><span class="co">## Average number of links: 1.9 </span></span>
<span><span class="co">## Link number distribution:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  1  2 </span></span>
<span><span class="co">##  2 18 </span></span>
<span><span class="co">## 2 least connected regions:</span></span>
<span><span class="co">## 1:1 1:20 with 1 link</span></span>
<span><span class="co">## 18 most connected regions:</span></span>
<span><span class="co">## 1:2 1:3 1:4 1:5 1:6 1:7 1:8 1:9 1:10 1:11 1:12 1:13 1:14 1:15 1:16 1:17 1:18 1:19 with 2 links</span></span></code></pre>
<p>All sites have two neighbors except the first and the last one.</p>
</div>
<div class="section level3">
<h3 id="irregular-sampling">Irregular sampling<a class="anchor" aria-label="anchor" href="#irregular-sampling"></a>
</h3>
<p>There are many ways to define the neighborhood in the case of
irregular samplings. We consider a random subsample of 20 sites of the
<code>mafragh</code> data set to better illustrate the differences
between methods:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">xyir</span> <span class="op">&lt;-</span> <span class="va">mxy</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">$</span><span class="va">xy</span><span class="op">)</span>, <span class="fl">20</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.label.html" class="external-link">s.label</a></span><span class="op">(</span><span class="va">xyir</span>, main <span class="op">=</span> <span class="st">"Irregular sampling with 20 sites"</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-11-1.png" width="700" style="display: block; margin: auto;"></p>
<p>The most intuitive way is to consider that sites are neighbors (or
not) according to the distances between them. This definition is
provided by the <code>dnearneigh</code> function:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nbnear1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/dnearneigh.html" class="external-link">dnearneigh</a></span><span class="op">(</span><span class="va">xyir</span>, <span class="fl">0</span>, <span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">nbnear2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/dnearneigh.html" class="external-link">dnearneigh</a></span><span class="op">(</span><span class="va">xyir</span>, <span class="fl">0</span>, <span class="fl">305</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.label.html" class="external-link">s.label</a></span><span class="op">(</span><span class="va">xyir</span>, nb <span class="op">=</span> <span class="va">nbnear1</span>, pnb.edge.col <span class="op">=</span> <span class="st">"red"</span>, main <span class="op">=</span> <span class="st">"neighbors if 0&lt;d&lt;50"</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">g2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.label.html" class="external-link">s.label</a></span><span class="op">(</span><span class="va">xyir</span>, nb <span class="op">=</span> <span class="va">nbnear2</span>, pnb.edge.col <span class="op">=</span> <span class="st">"red"</span>, main <span class="op">=</span> <span class="st">"neighbors if 0&lt;d&lt;305"</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/cbindADEg.html" class="external-link">cbindADEg</a></span><span class="op">(</span><span class="va">g1</span>, <span class="va">g2</span>, plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-12-1.png" width="480" style="display: block; margin: auto;"></p>
<p>Using a distance-based criteria could lead to unbalanced graphs. For
instance, if the maximum distance is too low, some points have no
neighbors:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nbnear1</span></span></code></pre></div>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 20 </span></span>
<span><span class="co">## Number of nonzero links: 38 </span></span>
<span><span class="co">## Percentage nonzero weights: 9.5 </span></span>
<span><span class="co">## Average number of links: 1.9 </span></span>
<span><span class="co">## 4 disjoint connected subgraphs</span></span></code></pre>
<p>On the other hand, if the maximum distance is too high, all sites are
connected:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nbnear2</span></span></code></pre></div>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 20 </span></span>
<span><span class="co">## Number of nonzero links: 354 </span></span>
<span><span class="co">## Percentage nonzero weights: 88.5 </span></span>
<span><span class="co">## Average number of links: 17.7</span></span></code></pre>
<p>It is also possible to define neighborhood by a criteria based on
nearest neighbors. However, this option can lead to non-symmetric
neighborhood: if site A is the nearest neighbor of site B, it does not
mean that site B is the nearest neighbor of site A.</p>
<p>The function <code>knearneigh</code> creates an object of class
<code>knn</code>. It can be transformed into a <code>nb</code> object
with the function <code>knn2nb</code>. This function has an argument
<code>sym</code> which can be set to <code>TRUE</code> to force the
output neighborhood to symmetry.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">knn1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/knearneigh.html" class="external-link">knearneigh</a></span><span class="op">(</span><span class="va">xyir</span>, k <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">nbknn1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/knn2nb.html" class="external-link">knn2nb</a></span><span class="op">(</span><span class="va">knn1</span>, sym <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">knn2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/knearneigh.html" class="external-link">knearneigh</a></span><span class="op">(</span><span class="va">xyir</span>, k <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">nbknn2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/knn2nb.html" class="external-link">knn2nb</a></span><span class="op">(</span><span class="va">knn2</span>, sym <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.label.html" class="external-link">s.label</a></span><span class="op">(</span><span class="va">xyir</span>, nb <span class="op">=</span> <span class="va">nbknn1</span>, pnb.edge.col <span class="op">=</span> <span class="st">"red"</span>, main <span class="op">=</span> <span class="st">"Nearest neighbors (k=1)"</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">g2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.label.html" class="external-link">s.label</a></span><span class="op">(</span><span class="va">xyir</span>, nb <span class="op">=</span> <span class="va">nbknn2</span>, pnb.edge.col <span class="op">=</span> <span class="st">"red"</span>, main <span class="op">=</span> <span class="st">"Nearest neighbors (k=2)"</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/cbindADEg.html" class="external-link">cbindADEg</a></span><span class="op">(</span><span class="va">g1</span>, <span class="va">g2</span>, plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-15-1.png" width="480" style="display: block; margin: auto;"></p>
<p>This definition of neighborhood can lead to unconnected subgraphs.
The function <code>n.comp.nb</code> finds the number of disjoint
connected subgraphs:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/compon.html" class="external-link">n.comp.nb</a></span><span class="op">(</span><span class="va">nbknn1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $nc</span></span>
<span><span class="co">## [1] 7</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $comp.id</span></span>
<span><span class="co">##  [1] 1 2 3 1 4 5 3 6 2 3 3 7 1 6 5 4 7 5 7 3</span></span></code></pre>
<p>More elaborate procedures are available to define neighborhood. For
instance, Delaunay triangulation is obtained with the function
<code>tri2nb</code>. It requires the package <code>deldir</code>. Other
graph-based procedures are also available:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nbtri</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/tri2nb.html" class="external-link">tri2nb</a></span><span class="op">(</span><span class="va">xyir</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in sn2listw(df1): style is M (missing); style should be set to a valid</span></span>
<span><span class="co">## value</span></span></code></pre>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nbgab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/graphneigh.html" class="external-link">graph2nb</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/graphneigh.html" class="external-link">gabrielneigh</a></span><span class="op">(</span><span class="va">xyir</span><span class="op">)</span>, sym <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">nbrel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/graphneigh.html" class="external-link">graph2nb</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/graphneigh.html" class="external-link">relativeneigh</a></span><span class="op">(</span><span class="va">xyir</span><span class="op">)</span>, sym <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.label.html" class="external-link">s.label</a></span><span class="op">(</span><span class="va">xyir</span>, nb <span class="op">=</span> <span class="va">nbtri</span>, pnb.edge.col <span class="op">=</span> <span class="st">"red"</span>, main <span class="op">=</span> <span class="st">"Delaunay"</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">g2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.label.html" class="external-link">s.label</a></span><span class="op">(</span><span class="va">xyir</span>, nb <span class="op">=</span> <span class="va">nbgab</span>, pnb.edge.col <span class="op">=</span> <span class="st">"red"</span>, main <span class="op">=</span> <span class="st">"Gabriel"</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">g3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.label.html" class="external-link">s.label</a></span><span class="op">(</span><span class="va">xyir</span>, nb <span class="op">=</span> <span class="va">nbrel</span>, pnb.edge.col <span class="op">=</span> <span class="st">"red"</span>, main <span class="op">=</span> <span class="st">"Relative"</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/ADEgS.html" class="external-link">ADEgS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">g1</span>, <span class="va">g2</span>, <span class="va">g3</span><span class="op">)</span><span class="op">)</span>    </span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-17-1.png" width="700" style="display: block; margin: auto;"></p>
<p>The <code>adespatial</code> functions <code>chooseCN</code> and
<code>listw.candidates</code> provides simple ways to build spatial
neighborhoods. They are wrappers of many of the <code>spdep</code>
functions presented above. The function <code>listw.explore</code> is an
interactive graphical interface that allows to generate R code to build
neighborhood objects (see <a href="#listw.explore">Figure 2</a>).</p>
</div>
<div class="section level3">
<h3 id="manipulating-nb-objects">Manipulating <code>nb</code> objects<a class="anchor" aria-label="anchor" href="#manipulating-nb-objects"></a>
</h3>
<p>A <code>nb</code> object is not stored as a matrix. It is a list of
neighbors. The neighbors of the first site are in the first element of
the list:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nbgab</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1]  6 13</span></span></code></pre>
<p>Various tools are provided by <code>spdep</code> to deal with these
objects. For instance, it is possible to identify differences between
two neighborhoods:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/diffnb.html" class="external-link">diffnb</a></span><span class="op">(</span><span class="va">nbgab</span>, <span class="va">nbrel</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 20 </span></span>
<span><span class="co">## Number of nonzero links: 14 </span></span>
<span><span class="co">## Percentage nonzero weights: 3.5 </span></span>
<span><span class="co">## Average number of links: 0.7 </span></span>
<span><span class="co">## 10 regions with no links:</span></span>
<span><span class="co">## 4 5 7 9 10 11 16 17 18 20</span></span>
<span><span class="co">## 13 disjoint connected subgraphs</span></span></code></pre>
<p>Usually, it can be useful to remove some connections due to edge
effects. In this case, the function <code>edit.nb</code> provides an
interactive tool to add or delete connections.</p>
<p>The function <code>include.self</code> allows to include a site in
its own list of neighbors (self-loops). The <code>spdep</code> package
provides many other tools to manipulate <code>nb</code> objects:</p>
<pre><code><span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nboperations.html" class="external-link">intersect.nb</a></span><span class="op">(</span><span class="va">nb.obj1</span>, <span class="va">nb.obj2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nboperations.html" class="external-link">union.nb</a></span><span class="op">(</span><span class="va">nb.obj1</span>, <span class="va">nb.obj2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nboperations.html" class="external-link">setdiff.nb</a></span><span class="op">(</span><span class="va">nb.obj1</span>, <span class="va">nb.obj2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nboperations.html" class="external-link">complement.nb</a></span><span class="op">(</span><span class="va">nb.obj</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/droplinks.html" class="external-link">droplinks</a></span><span class="op">(</span><span class="va">nb</span>, <span class="va">drop</span>, sym <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nblag.html" class="external-link">nblag</a></span><span class="op">(</span><span class="va">neighbours</span>, <span class="va">maxlag</span><span class="op">)</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="swm">Defining spatial weighting matrices<a class="anchor" aria-label="anchor" href="#swm"></a>
</h2>
<p>A spatial weighting matrices (SWM) is computed by a transformation of
a spatial neighborhood. We consider the Gabriel graph for the full data
set:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nbgab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/graphneigh.html" class="external-link">graph2nb</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/graphneigh.html" class="external-link">gabrielneigh</a></span><span class="op">(</span><span class="va">mxy</span><span class="op">)</span>, sym <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>In R, SWM are not stored as matrices but as objects of the class
<code>listw</code>. This format is more efficient than a matrix
representation to manage large data sets. An object of class
<code>listw</code> can be easily created from an object of class
<code>nb</code> with the function <code>nb2listw</code>.</p>
<p>Different objects <code>listw</code> can be obtained from a
<code>nb</code> object. The argument <code>style</code> allows to define
a transformation of the matrix such as standardization by row sum, by
total sum or binary coding, etc. General spatial weights can be
introduced by the argument <code>glist</code>. This allows to introduce,
for instance, a weighting relative to the distances between the points.
For this task, the function <code>nbdists</code> is very useful as it
computes Euclidean distance between neighbor sites defined by an
<code>nb</code> object.</p>
<p>To obtain a simple row-standardization, the function is simply called
by:</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html" class="external-link">nb2listw</a></span><span class="op">(</span><span class="va">nbgab</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Characteristics of weights list object:</span></span>
<span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 97 </span></span>
<span><span class="co">## Number of nonzero links: 450 </span></span>
<span><span class="co">## Percentage nonzero weights: 4.782655 </span></span>
<span><span class="co">## Average number of links: 4.639175 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Weights style: W </span></span>
<span><span class="co">## Weights constants summary:</span></span>
<span><span class="co">##    n   nn S0      S1       S2</span></span>
<span><span class="co">## W 97 9409 97 45.3915 395.3193</span></span></code></pre>
<p>More sophisticated forms of spatial weighting matrices can be
defined. For instance, it is possible to weight edges between neighbors
as functions of geographic distances. In a fist step, distances between
neighbors are obtained by the function :</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">distgab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nbdists.html" class="external-link">nbdists</a></span><span class="op">(</span><span class="va">nbgab</span>, <span class="va">mxy</span><span class="op">)</span></span>
<span><span class="va">nbgab</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2 4 5 6</span></span></code></pre>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">distgab</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 16.63971 21.34986 14.54966 16.99176</span></span></code></pre>
<p>Then, spatial weights are defined as a function of distance
(e.g. <span class="math inline">\(1-d_{ij}/max(d_{ij})\)</span>):</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fdist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">distgab</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">dist</a></span><span class="op">(</span><span class="va">mxy</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>And the spatial weighting matrix is then created:</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">listwgab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html" class="external-link">nb2listw</a></span><span class="op">(</span><span class="va">nbgab</span>, glist <span class="op">=</span> <span class="va">fdist</span><span class="op">)</span></span>
<span><span class="va">listwgab</span></span></code></pre></div>
<pre><code><span><span class="co">## Characteristics of weights list object:</span></span>
<span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 97 </span></span>
<span><span class="co">## Number of nonzero links: 450 </span></span>
<span><span class="co">## Percentage nonzero weights: 4.782655 </span></span>
<span><span class="co">## Average number of links: 4.639175 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Weights style: W </span></span>
<span><span class="co">## Weights constants summary:</span></span>
<span><span class="co">##    n   nn S0       S1     S2</span></span>
<span><span class="co">## W 97 9409 97 45.41085 395.21</span></span></code></pre>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">listwgab</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "style"      "neighbours" "weights"</span></span></code></pre>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">listwgab</span><span class="op">$</span><span class="va">neighbours</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2 4 5 6</span></span></code></pre>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">listwgab</span><span class="op">$</span><span class="va">weights</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.2505174 0.2472375 0.2519728 0.2502723</span></span></code></pre>
<p>The matrix representation of a <code>listw</code> object can also be
obtained:</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2mat.html" class="external-link">listw2mat</a></span><span class="op">(</span><span class="va">listwgab</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     [,1]  [,2]  [,3]  [,4]  [,5]  [,6]  [,7]  [,8]  [,9] [,10]</span></span>
<span><span class="co">## 1  0.000 0.251 0.000 0.247 0.252 0.250 0.000 0.000 0.000     0</span></span>
<span><span class="co">## 2  0.250 0.000 0.250 0.000 0.000 0.250 0.250 0.000 0.000     0</span></span>
<span><span class="co">## 3  0.000 0.251 0.000 0.000 0.000 0.000 0.251 0.249 0.249     0</span></span>
<span><span class="co">## 4  0.199 0.000 0.000 0.000 0.201 0.200 0.000 0.000 0.000     0</span></span>
<span><span class="co">## 5  0.503 0.000 0.000 0.497 0.000 0.000 0.000 0.000 0.000     0</span></span>
<span><span class="co">## 6  0.201 0.201 0.000 0.199 0.000 0.000 0.202 0.000 0.000     0</span></span>
<span><span class="co">## 7  0.000 0.200 0.200 0.000 0.000 0.201 0.000 0.199 0.000     0</span></span>
<span><span class="co">## 8  0.000 0.000 0.167 0.000 0.000 0.000 0.167 0.000 0.167     0</span></span>
<span><span class="co">## 9  0.000 0.000 0.333 0.000 0.000 0.000 0.000 0.335 0.000     0</span></span>
<span><span class="co">## 10 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000     0</span></span></code></pre>
<p>To facilitate the building of spatial neighborhoods (<code>nb</code>
object) and associated spatial weighting matrices (<code>listw</code>
object), the package <code>adespatial</code> provides several tools. An
interactive graphical interface is launched by the call
<code><a href="../reference/listw.explore.html">listw.explore()</a></code> assuming that spatial coordinates are still
stored in an object of the R session (<a href="#listw.explore">Figure
2</a>).</p>
<br><div style="text-align:center">
<p><a name="listw.explore"></a>
<img src="listw_explore.png" style="width:700px"><span style="color:blue">Figure 2: The interactive interface provided by the
function <code>listw.explore</code>. </span></p>
</div>
<p><br></p>
</div>
<div class="section level2">
<h2 id="creating-spatial-predictors">Creating spatial predictors<a class="anchor" aria-label="anchor" href="#creating-spatial-predictors"></a>
</h2>
<p>The package <code>adespatial</code> provide different tools to build
spatial predictors that can be incorporated in multivariate analysis.
They are orthogonal vectors stored in a object of class
<code>orthobasisSp</code>. Orthogonal polynomials of geographic
coordinates can be computed by the function <code>orthobasis.poly</code>
whereas principal coordinates of neighbour matrices (PCNM, <span class="citation">Borcard and Legendre (<a href="#ref-Borcard2002" role="doc-biblioref">2002</a>)</span>) are obtained by the function
<code>dbmem</code>.</p>
<p>The Moran’s Eigenvectors Maps (MEMs) provide the most flexible
framework. If we consider the <span class="math inline">\(n \times
n\)</span> spatial weighting matrix <span class="math inline">\(\mathbf{W} = [w_{ij}]\)</span>, they are the <span class="math inline">\(n-1\)</span> eigenvectors obtained by the
diagonalization of the doubly-centred SWM:</p>
<p><span class="math display">\[
\mathbf{\Omega V}= \mathbf{V \Lambda}
\]</span></p>
<p>where <span class="math inline">\(\mathbf{\Omega} =
\mathbf{HWH}\)</span> is the doubly-centred SWM and <span class="math inline">\(\mathbf{H} = \left (
\mathbf{I}-\mathbf{11}\hspace{-0.05cm}^{\top}\hspace{-0.05cm}/n \right
)\)</span> is the centring operator.</p>
<p>MEMs are orthogonal vectors with a unit norm that maximize Moran’s
coefficient of spatial autocorrelation <span class="citation">(<a href="#ref-Griffith1996" role="doc-biblioref">Griffith 1996</a>; <a href="#ref-Dray2012" role="doc-biblioref">Dray et al. 2012</a>)</span>
and are stored in matrix <span class="math inline">\(\mathbf{V}\)</span>.</p>
<p>MEMs are provided by the functions <code>scores.listw</code> or
<code>mem</code> of the <code>adespatial</code> package. These two
functions are exactly identical (both are kept for historical reasons
and compatibility) and return an object of class
<code>orthobasisSp</code>.</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mem.gab</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mem.html">mem</a></span><span class="op">(</span><span class="va">listwgab</span><span class="op">)</span></span>
<span><span class="va">mem.gab</span></span></code></pre></div>
<pre><code><span><span class="co">## Orthobasis with 97 rows and 96 columns</span></span>
<span><span class="co">## Only 6 rows and 4 columns are shown</span></span>
<span><span class="co">##        MEM1      MEM2       MEM3        MEM4</span></span>
<span><span class="co">## 1 0.9251530 -2.050270 -0.6159371 -1.13648688</span></span>
<span><span class="co">## 2 0.8495416 -1.859746 -0.4163876 -0.57971608</span></span>
<span><span class="co">## 3 0.8092292 -1.699300 -0.1970169  0.02251458</span></span>
<span><span class="co">## 4 1.0455937 -2.177654 -0.7488499 -1.45727142</span></span>
<span><span class="co">## 5 0.7098875 -1.571499 -0.5144638 -1.00604362</span></span>
<span><span class="co">## 6 0.9629486 -2.017900 -0.5572747 -0.92335694</span></span></code></pre>
<p>This object contains MEMs, stored as a <code>data.frame</code> and
other attributes:</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">mem.gab</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "orthobasisSp" "orthobasis"   "data.frame"</span></span></code></pre>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attributes.html" class="external-link">attributes</a></span><span class="op">(</span><span class="va">mem.gab</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "names"     "class"     "row.names" "values"    "weights"   "call"</span></span></code></pre>
<p>The eigenvalues associated to MEMs are stored in the attribute called
<code>values</code>:</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    <span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">mem.gab</span>, <span class="st">"values"</span><span class="op">)</span>, </span>
<span>        main <span class="op">=</span> <span class="st">"Eigenvalues of the spatial weighting matrix"</span>, cex.main <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-28-1.png" width="700" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">oldpar</span><span class="op">)</span></span></code></pre></div>
<p>A <code>plot</code> method is provided to represent MEMs. By default,
eigenvectors are represented as a table (sites as rows, MEMs as
columns). This representation is usually not informative and it is
better to map MEMs in the geographical space by documenting the argument
<code>SpORcoords</code>:</p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mem.gab</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">30</span>, <span class="fl">40</span>, <span class="fl">50</span>, <span class="fl">60</span>, <span class="fl">70</span><span class="op">)</span><span class="op">]</span>, SpORcoords <span class="op">=</span> <span class="va">mxy</span><span class="op">)</span></span></code></pre></div>
<p>or using the more flexible <code>s.value</code> function:</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.value.html" class="external-link">s.value</a></span><span class="op">(</span><span class="va">mxy</span>, <span class="va">mem.gab</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">30</span>, <span class="fl">40</span>, <span class="fl">50</span>, <span class="fl">60</span>, <span class="fl">70</span><span class="op">)</span><span class="op">]</span>, symbol <span class="op">=</span> <span class="st">"circle"</span>, ppoint.cex <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-30-1.png" width="480" style="display: block; margin: auto;"></p>
<p>Moran’s I can be computed and tested for each eigenvector with the
<code>moran.randtest</code> function:</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">moranI</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/moran.randtest.html">moran.randtest</a></span><span class="op">(</span><span class="va">mem.gab</span>, <span class="va">listwgab</span>, <span class="fl">99</span><span class="op">)</span></span></code></pre></div>
<p>As demonstrated in <span class="citation">Dray, Legendre, and
Peres-Neto (<a href="#ref-Dray2006" role="doc-biblioref">2006</a>)</span>, eigenvalues and Moran’s I are
equal (post-multiply by a constant):</p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">mem.gab</span>, <span class="st">"values"</span><span class="op">)</span> <span class="op">/</span> <span class="va">moranI</span><span class="op">$</span><span class="va">obs</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## MEM1.statistic MEM2.statistic MEM3.statistic MEM4.statistic MEM5.statistic </span></span>
<span><span class="co">##     0.01030928     0.01030928     0.01030928     0.01030928     0.01030928 </span></span>
<span><span class="co">## MEM6.statistic </span></span>
<span><span class="co">##     0.01030928</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="describing-spatial-patterns">Describing spatial patterns<a class="anchor" aria-label="anchor" href="#describing-spatial-patterns"></a>
</h2>
<p>In the previous sections, we considered only the spatial information
as a geographic map, a spatial weighting matrix (SWM) or a basis of
spatial predictors (e.g., MEM). In the next sections, we will show how
the spatial information can be integrated to analyze multivariate data
and identify multiscale spatial patterns. The dataset
<code>mafragh</code> available in <code>ade4</code> will be used to
illustrate the different methods.</p>
<div class="section level3">
<h3 id="mc">Moran’s coefficient of spatial autocorrelation<a class="anchor" aria-label="anchor" href="#mc"></a>
</h3>
<p>The SWM can be used to compute the level of spatial autocorrelation
of a quantitative variable using the Moran’s coefficient. If we consider
the <span class="math inline">\(n \times 1\)</span> vector <span class="math inline">\(\mathbf{x} = \left ( {x_1 \cdots x_n } \right
)\hspace{-0.05cm}^{\top}\hspace{-0.05cm}\)</span> containing
measurements of a quantitative variable for <span class="math inline">\(n\)</span> sites and <span class="math inline">\(\mathbf{W} = [w_{ij}]\)</span> the SWM. The usual
formulation for Moran’s coefficient (MC) of spatial autocorrelation is:
<span class="math display">\[
MC(\mathbf{x}) = \frac{n\sum\nolimits_{\left( 2 \right)} {w_{ij} (x_i
-\bar
{x})(x_j -\bar {x})} }{\sum\nolimits_{\left( 2 \right)} {w_{ij} }
\sum\nolimits_{i = 1}^n {(x_i -\bar {x})^2} }\mbox{ where
}\sum\nolimits_{\left( 2 \right)} =\sum\limits_{i = 1}^n {\sum\limits_{j
= 1}^n
} \mbox{ with }i\ne j
\]</span></p>
<p>MC can be rewritten using matrix notation: <span class="math display">\[
MC(\mathbf{x}) =
\frac{n}{\mathbf{1}\hspace{-0.05cm}^{\top}\hspace{-0.05cm}\mathbf{W1}}\frac{\mathbf{z}\hspace{-0.05cm}^{\top}\hspace{-0.05cm}{\mathbf{Wz}}}{\mathbf{z}\hspace{-0.05cm}^{\top}\hspace{-0.05cm}\mathbf{z}}
\]</span> where <span class="math inline">\(\mathbf{z} = \left (
\mathbf{I}-\mathbf{1}\mathbf{1}\hspace{-0.05cm}^{\top}\hspace{-0.05cm}/n
\right )\mathbf{x}\)</span> is the vector of centred values (i.e., <span class="math inline">\(z_i = x_i-\bar{x}\)</span>).</p>
<p>The function <code>moran.mc</code> of the <code>spdep</code> package
allows to compute and test, by permutation, the significance of the
Moran’s coefficient. A wrapper is provided by the
<code>moran.randtest</code> function to test simultaneously and
independently the spatial structure for several variables.</p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sp.env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/SpatialPolygons.html" class="external-link">SpatialPolygonsDataFrame</a></span><span class="op">(</span>Sr <span class="op">=</span> <span class="va">mafragh</span><span class="op">$</span><span class="va">Spatial</span>, data <span class="op">=</span> <span class="va">mafragh</span><span class="op">$</span><span class="va">env</span>, match.ID <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">maps.env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.Spatial.html" class="external-link">s.Spatial</a></span><span class="op">(</span><span class="va">sp.env</span>, col <span class="op">=</span> <span class="fu">fpalette</span><span class="op">(</span><span class="fl">6</span><span class="op">)</span>, nclass <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-33-1.png" width="80%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MC.env</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/moran.randtest.html">moran.randtest</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">$</span><span class="va">env</span>, <span class="va">listwgab</span>, nrepet <span class="op">=</span> <span class="fl">999</span><span class="op">)</span></span>
<span><span class="va">MC.env</span></span></code></pre></div>
<pre><code><span><span class="co">## class: krandtest lightkrandtest </span></span>
<span><span class="co">## Monte-Carlo tests</span></span>
<span><span class="co">## Call: moran.randtest(x = mafragh$env, listw = listwgab, nrepet = 999)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Number of tests:   11 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Adjustment method for multiple comparisons:   none </span></span>
<span><span class="co">## Permutation number:   999 </span></span>
<span><span class="co">##            Test       Obs   Std.Obs   Alter Pvalue</span></span>
<span><span class="co">## 1          Clay 0.4464655  6.552261 greater  0.001</span></span>
<span><span class="co">## 2          Silt 0.3967605  5.946167 greater  0.001</span></span>
<span><span class="co">## 3          Sand 0.1218959  2.114549 greater  0.033</span></span>
<span><span class="co">## 4           K2O 0.2916865  4.470113 greater  0.001</span></span>
<span><span class="co">## 5          Mg++ 0.2040580  3.220200 greater  0.003</span></span>
<span><span class="co">## 6      Na+/100g 0.3404142  5.138034 greater  0.001</span></span>
<span><span class="co">## 7            K+ 0.6696787 10.193028 greater  0.001</span></span>
<span><span class="co">## 8  Conductivity 0.3843430  5.891744 greater  0.001</span></span>
<span><span class="co">## 9     Retention 0.2217547  3.609803 greater  0.003</span></span>
<span><span class="co">## 10        Na+/l 0.3075238  4.791118 greater  0.001</span></span>
<span><span class="co">## 11    Elevation 0.6136770  9.047577 greater  0.001</span></span></code></pre>
<p>For a given SWM, the upper and lower bounds of MC are equal to <span class="math inline">\(\lambda_{max}
(n/\mathbf{1}\hspace{-0.05cm}^{\top}\hspace{-0.05cm}\mathbf{W1})\)</span>
and <span class="math inline">\(\lambda_{min}
(n/\mathbf{1}\hspace{-0.05cm}^{\top}\hspace{-0.05cm}\mathbf{W1})\)</span>
where <span class="math inline">\(\lambda_{max}\)</span> and <span class="math inline">\(\lambda_{min}\)</span> are the extreme eigenvalues
of <span class="math inline">\(\mathbf{\Omega}\)</span>. These extreme
values are returned by the <code>moran.bounds</code> function:</p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mc.bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/moran.bounds.html">moran.bounds</a></span><span class="op">(</span><span class="va">listwgab</span><span class="op">)</span></span>
<span><span class="va">mc.bounds</span></span></code></pre></div>
<pre><code><span><span class="co">##       Imin       Imax </span></span>
<span><span class="co">## -0.9474872  1.0098330</span></span></code></pre>
<p>Hence, it is possible to display Moran’s coefficients computed on
environmental variables and the minimum and maximum values for the given
SWM:</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">env.maps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s1d.barchart.html" class="external-link">s1d.barchart</a></span><span class="op">(</span><span class="va">MC.env</span><span class="op">$</span><span class="va">obs</span>, labels <span class="op">=</span> <span class="va">MC.env</span><span class="op">$</span><span class="va">names</span>, plot <span class="op">=</span> <span class="cn">FALSE</span>, xlim <span class="op">=</span> <span class="fl">1.1</span> <span class="op">*</span> <span class="va">mc.bounds</span>, paxes.draw <span class="op">=</span> <span class="cn">TRUE</span>, pgrid.draw <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/addline.html" class="external-link">addline</a></span><span class="op">(</span><span class="va">env.maps</span>, v <span class="op">=</span> <span class="va">mc.bounds</span>, plot <span class="op">=</span> <span class="cn">TRUE</span>, pline.col <span class="op">=</span> <span class="st">'red'</span>, pline.lty <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-35-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="decomposing-morans-coefficient">Decomposing Moran’s coefficient<a class="anchor" aria-label="anchor" href="#decomposing-morans-coefficient"></a>
</h3>
<p>The standard test based on MC is not able to detect the coexistence
of positive and negative autocorrelation structures (i.e., it leads to a
non-significant test). The <code>moranNP.randtest</code> function allows
to decompose the standard MC statistic into two additive parts and thus
to test for positive and negative autocorrelation separately <span class="citation">(<a href="#ref-Dray2011" role="doc-biblioref">Dray
2011</a>)</span>. For instance, we can test the spatial distribution of
Magnesium. Only positive autocorrelation is detected:</p>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NP.Mg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/moranNP.randtest.html">moranNP.randtest</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">$</span><span class="va">env</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span>, <span class="va">listwgab</span>, nrepet <span class="op">=</span> <span class="fl">999</span>, alter <span class="op">=</span> <span class="st">"two-sided"</span><span class="op">)</span> </span>
<span><span class="va">NP.Mg</span></span></code></pre></div>
<pre><code><span><span class="co">## class: krandtest lightkrandtest </span></span>
<span><span class="co">## Monte-Carlo tests</span></span>
<span><span class="co">## Call: moranNP.randtest(x = mafragh$env[, 5], listw = listwgab, nrepet = 999, </span></span>
<span><span class="co">##     alter = "two-sided")</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Number of tests:   2 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Adjustment method for multiple comparisons:   none </span></span>
<span><span class="co">## Permutation number:   999 </span></span>
<span><span class="co">##   Test        Obs  Std.Obs   Alter Pvalue</span></span>
<span><span class="co">## 1   I+  0.3611756 3.743501 greater  0.002</span></span>
<span><span class="co">## 2   I- -0.1571176 1.552759    less  0.944</span></span></code></pre>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">NP.Mg</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-36-1.png" width="700" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">NP.Mg</span><span class="op">$</span><span class="va">obs</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.204058</span></span></code></pre>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MC.env</span><span class="op">$</span><span class="va">obs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## Mg++.statistic </span></span>
<span><span class="co">##       0.204058</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="multispati-analysis">MULTISPATI analysis<a class="anchor" aria-label="anchor" href="#multispati-analysis"></a>
</h3>
<p>When multivariate data are considered, it is possible to search for
spatial structures by computing univariate statistics (e.g., <a href="#mc">Moran’s Coefficient</a>) on each variable separately. Another
alternative is to summarize data by multivariate methods and then detect
spatial structures using the output of the analysis. For instance, we
applied a centred principal component analysis on the abundance
data:</p>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pca.hell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ade4/man/dudi.pca.html" class="external-link">dudi.pca</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">$</span><span class="va">flo</span>, scale <span class="op">=</span> <span class="cn">FALSE</span>, scannf <span class="op">=</span> <span class="cn">FALSE</span>, nf <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>MC can be computed for PCA scores and the associated spatial
structures can be visualized on a map:</p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/moran.randtest.html">moran.randtest</a></span><span class="op">(</span><span class="va">pca.hell</span><span class="op">$</span><span class="va">li</span>, listw <span class="op">=</span> <span class="va">listwgab</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## class: krandtest lightkrandtest </span></span>
<span><span class="co">## Monte-Carlo tests</span></span>
<span><span class="co">## Call: moran.randtest(x = pca.hell$li, listw = listwgab)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Number of tests:   2 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Adjustment method for multiple comparisons:   none </span></span>
<span><span class="co">## Permutation number:   999 </span></span>
<span><span class="co">##    Test       Obs  Std.Obs   Alter Pvalue</span></span>
<span><span class="co">## 1 Axis1 0.4830837 7.405295 greater  0.001</span></span>
<span><span class="co">## 2 Axis2 0.4613738 7.119489 greater  0.001</span></span></code></pre>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.value.html" class="external-link">s.value</a></span><span class="op">(</span><span class="va">mxy</span>, <span class="va">pca.hell</span><span class="op">$</span><span class="va">li</span>, Sp <span class="op">=</span> <span class="va">mafragh</span><span class="op">$</span><span class="va">Spatial.contour</span>, symbol <span class="op">=</span> <span class="st">"circle"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"white"</span>, <span class="st">"palegreen4"</span><span class="op">)</span>, ppoint.cex <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-38-1.png" width="576" style="display: block; margin: auto;"></p>
<p>PCA results are highly spatially structured. Results can be
optimized, compared to this two-step procedure, by searching directly
for multivariate spatial structures. The <code>multispati</code>
function implements a method <span class="citation">(<a href="#ref-Dray2008" role="doc-biblioref">Dray, Saïd, and Débias
2008</a>)</span> that search for axes maximizing the product of variance
(multivariate aspect) by MC (spatial aspect):</p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ms.hell</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/multispati.html">multispati</a></span><span class="op">(</span><span class="va">pca.hell</span>, listw <span class="op">=</span> <span class="va">listwgab</span>, scannf <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<p>The <code>summary</code> method can be applied on the resulting
object to compare the results of initial analysis (axis 1 (RS1) and axis
2 (RS2)) and those of the multispati method (CS1 and CS2):</p>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ms.hell</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Multivariate Spatial Analysis</span></span>
<span><span class="co">## Call: multispati(dudi = pca.hell, listw = listwgab, scannf = F)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Scores from the initial duality diagram:</span></span>
<span><span class="co">##          var      cum     ratio     moran</span></span>
<span><span class="co">## RS1 5.331174 5.331174 0.2834660 0.4830837</span></span>
<span><span class="co">## RS2 1.972986 7.304159 0.3883725 0.4613738</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Multispati eigenvalues decomposition:</span></span>
<span><span class="co">##          eig      var     moran</span></span>
<span><span class="co">## CS1 2.933824 4.833900 0.6069269</span></span>
<span><span class="co">## CS2 1.210573 1.892671 0.6396110</span></span></code></pre>
<p>The MULTISPATI analysis allows to better identify spatial structures
(higher MC values).</p>
<p>Scores of the analysis can be mapped and highlight some spatial
patterns of community composition:</p>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g.ms.maps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.value.html" class="external-link">s.value</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">$</span><span class="va">xy</span>, <span class="va">ms.hell</span><span class="op">$</span><span class="va">li</span>, Sp <span class="op">=</span> <span class="va">mafragh</span><span class="op">$</span><span class="va">Spatial.contour</span>, symbol <span class="op">=</span> <span class="st">"circle"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"white"</span>, <span class="st">"palegreen4"</span><span class="op">)</span>, ppoint.cex <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-41-1.png" width="576" style="display: block; margin: auto;"></p>
<p>The spatial distribution of several species can be inserted to
facilitate the interpretation of the outputs of the analysis:</p>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g.ms.spe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.arrow.html" class="external-link">s.arrow</a></span><span class="op">(</span><span class="va">ms.hell</span><span class="op">$</span><span class="va">c1</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">g.abund</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.value.html" class="external-link">s.value</a></span><span class="op">(</span><span class="va">mxy</span>, <span class="va">mafragh</span><span class="op">$</span><span class="va">flo</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">12</span>,<span class="fl">11</span>,<span class="fl">31</span>,<span class="fl">16</span><span class="op">)</span><span class="op">]</span>,</span>
<span>    Sp <span class="op">=</span> <span class="va">mafragh</span><span class="op">$</span><span class="va">Spatial.contour</span>, symbol <span class="op">=</span> <span class="st">"circle"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"palegreen4"</span><span class="op">)</span>, plegend.drawKey <span class="op">=</span> <span class="cn">FALSE</span>, ppoint.cex <span class="op">=</span> <span class="fl">0.4</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.65</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.25</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.74</span>, <span class="fl">0.58</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.55</span>, <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">g.ms.spe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/insert.html" class="external-link">insert</a></span><span class="op">(</span><span class="va">g.abund</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">g.ms.spe</span>, posi <span class="op">=</span> <span class="va">p1</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, ratio <span class="op">=</span> <span class="fl">0.25</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">g.ms.spe</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-42-1.png" width="480" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="multiscale-analysis-with-mem">Multiscale analysis with MEM<a class="anchor" aria-label="anchor" href="#multiscale-analysis-with-mem"></a>
</h2>
<p>All the methods presented in the previous section consider the whole
SWM to integrate the spatial information. In this section, we present
alternatives that use MEM to introduce the notion of space at multiple
scales.</p>
<div class="section level3">
<h3 id="scalogram-and-mspa">Scalogram and MSPA<a class="anchor" aria-label="anchor" href="#scalogram-and-mspa"></a>
</h3>
<p>The full set of MEMs provide a basis of orthogonal vectors that can
be used to decompose the total variance of a given variable at multiple
scales. This approach consists simply in computing <span class="math inline">\(R^2\)</span> values associated to each MEM to
build a scalogram indicating the part of variance explained by each MEM.
These values can be tested by a permutation procedure. Here, we
illustrate the procedure with the abundance of <em>Bolboschoenus
maritimus</em> (Sp11) which is mainly located in the central part of the
study area:</p>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scalo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/scalogram.html">scalogram</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">$</span><span class="va">flo</span><span class="op">[</span>,<span class="fl">11</span><span class="op">]</span>, <span class="va">mem.gab</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">scalo</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-43-1.png" width="700" style="display: block; margin: auto;">
As the number of MEMs is equal to the number of sites minus one and as
MEMs are othogonal, the variance is fully decomposed:</p>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">scalo</span><span class="op">$</span><span class="va">obs</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1</span></span></code></pre>
<p>When the number of MEMs is high, the results provided by this
approach can be difficult to interpret. In this case it can be
advantageous to use smoothed scalograms (using the <code>nblocks</code>
argument) where spatial components are formed by groups of successive
MEMs:</p>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/scalogram.html">scalogram</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">$</span><span class="va">flo</span><span class="op">[</span>,<span class="fl">11</span><span class="op">]</span>, <span class="fu"><a href="../reference/mem.html">mem</a></span><span class="op">(</span><span class="va">listwgab</span><span class="op">)</span>, nblocks <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-45-1.png" width="700" style="display: block; margin: auto;"></p>
<p>It is possible to compute scalograms for all the species of the data
table. These scalograms can be stored in a table and analysing this
table with a PCA allows to identify the important scales of the data set
and the similarities between species based on their spatial
distributions <span class="citation">(<a href="#ref-Jombart2009" role="doc-biblioref">Jombart, Dray, and Dufour 2009</a>)</span>. This
analysis named Multiscale Patterns Analysis (MSPA) is available in the
<code>mspa</code> function that takes the results of a multivariate
analysis (an object of class <code>dudi</code>) as argument:</p>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mspa.hell</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mspa.html">mspa</a></span><span class="op">(</span><span class="va">pca.hell</span>, <span class="va">listwgab</span>, scannf <span class="op">=</span> <span class="cn">FALSE</span>, nf <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g.mspa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ade4/man/scatter.html" class="external-link">scatter</a></span><span class="op">(</span><span class="va">mspa.hell</span>, posieig <span class="op">=</span> <span class="st">"topright"</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">g.mem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.value.html" class="external-link">s.value</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">$</span><span class="va">xy</span>, <span class="va">mem.gab</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">6</span>, <span class="fl">3</span><span class="op">)</span><span class="op">]</span>, Sp <span class="op">=</span> <span class="va">mafragh</span><span class="op">$</span><span class="va">Spatial.contour</span>, ppoints.cex <span class="op">=</span> <span class="fl">0.4</span>, plegend.drawKey <span class="op">=</span> <span class="cn">FALSE</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">g.abund</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.value.html" class="external-link">s.value</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">$</span><span class="va">xy</span>, <span class="va">mafragh</span><span class="op">$</span><span class="va">flo</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">31</span>,<span class="fl">54</span>,<span class="fl">25</span><span class="op">)</span><span class="op">]</span>, Sp <span class="op">=</span> <span class="va">mafragh</span><span class="op">$</span><span class="va">Spatial.contour</span>, symbol <span class="op">=</span> <span class="st">"circle"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"palegreen4"</span><span class="op">)</span>, plegend.drawKey <span class="op">=</span> <span class="cn">FALSE</span>, ppoint.cex <span class="op">=</span> <span class="fl">0.4</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.44</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.64</span>, <span class="fl">0.15</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.35</span>, <span class="fl">0.01</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.15</span>, <span class="fl">0.78</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">g.mspa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/insert.html" class="external-link">insert</a></span><span class="op">(</span><span class="va">g.mem</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">g.mspa</span>, posi <span class="op">=</span> <span class="va">p1</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.27</span>, <span class="fl">0.54</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.35</span>, <span class="fl">0.35</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.75</span>, <span class="fl">0.31</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">g.mspa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/insert.html" class="external-link">insert</a></span><span class="op">(</span><span class="va">g.abund</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">g.mspa</span>, posi <span class="op">=</span> <span class="va">p2</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g.mspa</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-46-1.png" width="480" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="selection-of-swm-and-mem">Selection of SWM and MEM<a class="anchor" aria-label="anchor" href="#selection-of-swm-and-mem"></a>
</h3>
<p>Scalograms and MSPA require the full set of MEMs to decompose the
total variation. However, regression-based methods (described in next
sections) could suffer from overfitting if the number of explanatory
variables is too high and thus require a procedure to reduce the number
of MEMs. The function <code>mem.select</code> proposes different
alternatives to perform this selection using the argument
<code>method</code> <span class="citation">(<a href="#ref-Bauman2018" role="doc-biblioref">Bauman, Drouet, Dray, et al. 2018</a>)</span>. By
default, only MEMs associated to positive eigenvalues are considered
(argument <code>MEM.autocor = "positive"</code>) and a forward selection
(based on <span class="math inline">\(R^2\)</span> statistic) is
performed after a global test (<code>method = "FWD"</code>):</p>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mem.gab.sel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mem.select.html">mem.select</a></span><span class="op">(</span><span class="va">pca.hell</span><span class="op">$</span><span class="va">tab</span>, listw <span class="op">=</span> <span class="va">listwgab</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Procedure stopped (alpha criteria): pvalue for variable 16 is 0.075000 (&gt; 0.050000)</span></span></code></pre>
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mem.gab.sel</span><span class="op">$</span><span class="va">global.test</span></span></code></pre></div>
<pre><code><span><span class="co">## $obs</span></span>
<span><span class="co">## [1] 0.3593333</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $pvalue</span></span>
<span><span class="co">## [1] 1e-04</span></span></code></pre>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mem.gab.sel</span><span class="op">$</span><span class="va">summary</span></span></code></pre></div>
<pre><code><span><span class="co">##    variables order         R2      R2Cum   AdjR2Cum pvalue</span></span>
<span><span class="co">## 1       MEM1     1 0.08696619 0.08696619 0.07735531  0.001</span></span>
<span><span class="co">## 2       MEM2     2 0.05675316 0.14371935 0.12550061  0.001</span></span>
<span><span class="co">## 3       MEM6     6 0.04244014 0.18615948 0.15990656  0.001</span></span>
<span><span class="co">## 4       MEM4     4 0.03528604 0.22144553 0.18759533  0.001</span></span>
<span><span class="co">## 5       MEM5     5 0.02987158 0.25131711 0.21018069  0.002</span></span>
<span><span class="co">## 6      MEM12    12 0.02553209 0.27684919 0.22863914  0.001</span></span>
<span><span class="co">## 7       MEM3     3 0.02515410 0.30200330 0.24710468  0.002</span></span>
<span><span class="co">## 8       MEM7     7 0.01870460 0.32070790 0.25895407  0.010</span></span>
<span><span class="co">## 9      MEM10    10 0.01810649 0.33881440 0.27041589  0.012</span></span>
<span><span class="co">## 10     MEM17    17 0.01801775 0.35683215 0.28204519  0.019</span></span>
<span><span class="co">## 11     MEM31    31 0.01549756 0.37232971 0.29110179  0.016</span></span>
<span><span class="co">## 12      MEM9     9 0.01472660 0.38705632 0.29949293  0.024</span></span>
<span><span class="co">## 13     MEM11    11 0.01390862 0.40096493 0.30714016  0.036</span></span>
<span><span class="co">## 14     MEM35    35 0.01279786 0.41376280 0.31367352  0.045</span></span>
<span><span class="co">## 15     MEM16    16 0.01217328 0.42593608 0.31962795  0.040</span></span></code></pre>
<p>Results of the global test and of the forward selection are returned
in elements <code>global.test</code> and <code>summary</code>. The
subset of selected MEMs are in <code>MEM.select</code> and can be used
in subsequent analysis (see sections on <a href="#rda">Redundancy
Analysis</a> and <a href="#varpart">Variation Partitioning</a>).</p>
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">mem.gab.sel</span><span class="op">$</span><span class="va">MEM.select</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "orthobasisSp" "orthobasis"   "data.frame"</span></span></code></pre>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">mem.gab.sel</span><span class="op">$</span><span class="va">MEM.select</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 97 15</span></span></code></pre>
<p>Different SWMs can be defined for a given data set. An important
issue concerns the selection of a SWM. This choice can be driven by
biological hypotheses but a data-driven procedure is provided by the
<code>listw.select</code> function. A list of potential candidates can
be built using the <code>listw.candidates</code> function. Here, we
create four candidates using two definitions for neighborhood (Gabriel
and Relative graphs using <code>c("gab", "rel")</code>) and two
weighting functions (binary and linear using
<code>c("bin", "flin")</code>):</p>
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cand.lw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/listw.candidates.html">listw.candidates</a></span><span class="op">(</span><span class="va">mxy</span>, nb <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gab"</span>, <span class="st">"rel"</span><span class="op">)</span>, weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bin"</span>, <span class="st">"flin"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The function <code>listw.select</code> proposes different methods for
selecting a SWM <span class="citation">(<a href="#ref-Bauman2018a" role="doc-biblioref">Bauman, Drouet, Fortin, et al. 2018</a>)</span>.
The procedure is very similar to the one proposed by
<code>mem.select</code> except that p-value corrections are applied on
global tests taking into account the fact that several candidates are
used. By default (<code>method = "FWD"</code>), it applies forward
selection on the significant SWMs and selects among these the SWM for
which the subset of MEMs yields the highest adjusted R.</p>
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sel.lw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/listw.select.html">listw.select</a></span><span class="op">(</span><span class="va">pca.hell</span><span class="op">$</span><span class="va">tab</span>, candidates <span class="op">=</span> <span class="va">cand.lw</span>, nperm <span class="op">=</span> <span class="fl">99</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Procedure stopped (alpha criteria): pvalue for variable 16 is 0.080000 (&gt; 0.050000)</span></span>
<span><span class="co">## Procedure stopped (alpha criteria): pvalue for variable 15 is 0.060000 (&gt; 0.050000)</span></span>
<span><span class="co">## Procedure stopped (alpha criteria): pvalue for variable 19 is 0.070000 (&gt; 0.050000)</span></span>
<span><span class="co">## Procedure stopped (alpha criteria): pvalue for variable 20 is 0.100000 (&gt; 0.050000)</span></span></code></pre>
<p>A summary of the procedure is available:</p>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sel.lw</span><span class="op">$</span><span class="va">candidates</span></span></code></pre></div>
<pre><code><span><span class="co">##                     R2Adj     Pvalue N.var R2Adj.select</span></span>
<span><span class="co">## Gabriel_Binary  0.3571605 0.00039994    15    0.2938182</span></span>
<span><span class="co">## Gabriel_Linear  0.3745815 0.00039994    14    0.3059982</span></span>
<span><span class="co">## Relative_Binary 0.3788734 0.00039994    18    0.3299666</span></span>
<span><span class="co">## Relative_Linear 0.3728263 0.00039994    19    0.3349199</span></span></code></pre>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sel.lw</span><span class="op">$</span><span class="va">best.id</span></span></code></pre></div>
<pre><code><span><span class="co">## Relative_Linear </span></span>
<span><span class="co">##               4</span></span></code></pre>
<p>The corresponding SWM can be obtained by</p>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lw.best</span> <span class="op">&lt;-</span> <span class="va">cand.lw</span><span class="op">[[</span><span class="va">sel.lw</span><span class="op">$</span><span class="va">best.id</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p>The subset of MEMs corresponding to the best SWM is also returned by
the function:</p>
<div class="sourceCode" id="cb131"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sel.lw</span><span class="op">$</span><span class="va">best</span></span></code></pre></div>
<pre><code><span><span class="co">## $global.test</span></span>
<span><span class="co">## $global.test$obs</span></span>
<span><span class="co">## [1] 0.3728263</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $global.test$pvalue</span></span>
<span><span class="co">## [1] 0.00039994</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $MEM.select</span></span>
<span><span class="co">## Orthobasis with 97 rows and 19 columns</span></span>
<span><span class="co">## Only 6 rows and 4 columns are shown</span></span>
<span><span class="co">##          MEM8     MEM2       MEM7       MEM3</span></span>
<span><span class="co">## 1  0.57335813 2.041032 -0.3239282 -0.2075280</span></span>
<span><span class="co">## 2  0.84824433 1.753831  0.9633804 -0.1781151</span></span>
<span><span class="co">## 3  0.58158368 1.020786  1.1627724 -0.1024424</span></span>
<span><span class="co">## 4 -0.68418987 1.297336 -2.5394961 -0.1218499</span></span>
<span><span class="co">## 5 -0.03242453 1.254399 -1.1615363 -0.1271501</span></span>
<span><span class="co">## 6  0.49026241 2.343757 -0.3132711 -0.2287866</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $summary</span></span>
<span><span class="co">##    variables order         R2     R2Cum   AdjR2Cum pvalue</span></span>
<span><span class="co">## 1       MEM8     8 0.05804130 0.0580413 0.04812594   0.01</span></span>
<span><span class="co">## 2       MEM2     2 0.04694559 0.1049869 0.08594406   0.01</span></span>
<span><span class="co">## 3       MEM7     7 0.04184439 0.1468313 0.11930971   0.01</span></span>
<span><span class="co">## 4       MEM3     3 0.03648604 0.1833173 0.14780937   0.01</span></span>
<span><span class="co">## 5      MEM38    38 0.03294060 0.2162579 0.17319516   0.01</span></span>
<span><span class="co">## 6       MEM1     1 0.02556350 0.2418214 0.19127617   0.01</span></span>
<span><span class="co">## 7      MEM11    11 0.02461285 0.2664343 0.20873808   0.01</span></span>
<span><span class="co">## 8      MEM22    22 0.02301480 0.2894491 0.22485352   0.01</span></span>
<span><span class="co">## 9       MEM9     9 0.01962969 0.3090788 0.23760414   0.01</span></span>
<span><span class="co">## 10     MEM13    13 0.01827667 0.3273554 0.24914093   0.02</span></span>
<span><span class="co">## 11      MEM6     6 0.01795449 0.3453099 0.26058531   0.01</span></span>
<span><span class="co">## 12     MEM12    12 0.01699980 0.3623097 0.27121110   0.01</span></span>
<span><span class="co">## 13     MEM16    16 0.01698129 0.3792910 0.28207151   0.03</span></span>
<span><span class="co">## 14     MEM37    37 0.01683864 0.3961296 0.29302982   0.02</span></span>
<span><span class="co">## 15     MEM14    14 0.01669087 0.4128205 0.30408356   0.02</span></span>
<span><span class="co">## 16     MEM21    21 0.01363371 0.4264542 0.31174506   0.03</span></span>
<span><span class="co">## 17     MEM27    27 0.01355500 0.4400092 0.31950487   0.02</span></span>
<span><span class="co">## 18     MEM17    17 0.01343125 0.4534405 0.32731134   0.02</span></span>
<span><span class="co">## 19      MEM5     5 0.01310988 0.4665504 0.33491992   0.04</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="rda">Canonical Analysis<a class="anchor" aria-label="anchor" href="#rda"></a>
</h3>
<p>Canonical methods are widely used to explain the structure of an
abundance table by environmental and/or spatial variables. For instance,
Redundancy Analysis (RDA) is available in functions <code>pcaiv</code>
(package <code>ade4</code>) or <code>rda</code> (package
<code>vegan</code>). RDA can be applied using selected MEMs as
explanatory variables to study the spatial patterns in plant
communities, :</p>
<div class="sourceCode" id="cb133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rda.hell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ade4/man/pcaiv.html" class="external-link">pcaiv</a></span><span class="op">(</span><span class="va">pca.hell</span>, <span class="va">sel.lw</span><span class="op">$</span><span class="va">best</span><span class="op">$</span><span class="va">MEM.select</span>, scannf <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>The permutation test based on the percentage of variation explained
by the spatial predictors (<span class="math inline">\(R^2\)</span>) is
highly significant:</p>
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test.rda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ade4/man/randtest.html" class="external-link">randtest</a></span><span class="op">(</span><span class="va">rda.hell</span><span class="op">)</span></span>
<span><span class="va">test.rda</span></span></code></pre></div>
<pre><code><span><span class="co">## Monte-Carlo test</span></span>
<span><span class="co">## Call: randtest.pcaiv(xtest = rda.hell)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Observation: 0.4665504 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Based on 99 replicates</span></span>
<span><span class="co">## Simulated p-value: 0.01 </span></span>
<span><span class="co">## Alternative hypothesis: greater </span></span>
<span><span class="co">## </span></span>
<span><span class="co">##      Std.Obs  Expectation     Variance </span></span>
<span><span class="co">## 15.485157208  0.195439797  0.000306522</span></span></code></pre>
<div class="sourceCode" id="cb136"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">test.rda</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-55-1.png" width="700" style="display: block; margin: auto;"></p>
<p>Associated spatial structures can be mapped:</p>
<div class="sourceCode" id="cb137"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/adegraphics/man/s.value.html" class="external-link">s.value</a></span><span class="op">(</span><span class="va">mxy</span>, <span class="va">rda.hell</span><span class="op">$</span><span class="va">li</span>, Sp <span class="op">=</span> <span class="va">mafragh</span><span class="op">$</span><span class="va">Spatial.contour</span>, symbol <span class="op">=</span> <span class="st">"circle"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"white"</span>, <span class="st">"palegreen4"</span><span class="op">)</span>, ppoint.cex <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-56-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="varpart">Variation partitioning<a class="anchor" aria-label="anchor" href="#varpart"></a>
</h3>
<p>Spatial structures identified by Redundancy Analysis in the <a href="#rda">previous section</a> can be due to niche filtering or other
processes (e.g., neutral dynamics). Variation partitioning <span class="citation">(<a href="#ref-Borcard1992" role="doc-biblioref">Borcard, Legendre, and Drapeau 1992</a>)</span>
based on adjusted <span class="math inline">\(R^2\)</span> <span class="citation">(<a href="#ref-Peres-Neto2006a" role="doc-biblioref">Peres-Neto et al. 2006</a>)</span> can be used to
identify the part of spatial structures that can be explained or not by
environmental predictors. This method is implemented in the function
<code>varpart</code> of package <code>vegan</code> that is able to deal
with up to four tables of predictors:</p>
<div class="sourceCode" id="cb138"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/vegandevs/vegan" class="external-link">vegan</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: permute</span></span></code></pre>
<pre><code><span><span class="co">## Loading required package: lattice</span></span></code></pre>
<pre><code><span><span class="co">## This is vegan 2.6-4</span></span></code></pre>
<div class="sourceCode" id="cb142"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vp1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="va">pca.hell</span><span class="op">$</span><span class="va">tab</span>, <span class="va">mafragh</span><span class="op">$</span><span class="va">env</span>, <span class="va">sel.lw</span><span class="op">$</span><span class="va">best</span><span class="op">$</span><span class="va">MEM.select</span><span class="op">)</span></span>
<span><span class="va">vp1</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Partition of variance in RDA </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Call: varpart(Y = pca.hell$tab, X = mafragh$env,</span></span>
<span><span class="co">## sel.lw$best$MEM.select)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Explanatory tables:</span></span>
<span><span class="co">## X1:  mafragh$env</span></span>
<span><span class="co">## X2:  sel.lw$best$MEM.select </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## No. of explanatory tables: 2 </span></span>
<span><span class="co">## Total variation (SS): 1824.3 </span></span>
<span><span class="co">##             Variance: 19.003 </span></span>
<span><span class="co">## No. of observations: 97 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Partition table:</span></span>
<span><span class="co">##                      Df R.squared Adj.R.squared Testable</span></span>
<span><span class="co">## [a+c] = X1           11   0.23666       0.13787     TRUE</span></span>
<span><span class="co">## [b+c] = X2           19   0.46655       0.33492     TRUE</span></span>
<span><span class="co">## [a+b+c] = X1+X2      30   0.55492       0.35260     TRUE</span></span>
<span><span class="co">## Individual fractions                                    </span></span>
<span><span class="co">## [a] = X1|X2          11                 0.01768     TRUE</span></span>
<span><span class="co">## [b] = X2|X1          19                 0.21473     TRUE</span></span>
<span><span class="co">## [c]                   0                 0.12019    FALSE</span></span>
<span><span class="co">## [d] = Residuals                         0.64740    FALSE</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Use function 'rda' to test significance of fractions of interest</span></span></code></pre>
<div class="sourceCode" id="cb144"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">vp1</span>, bg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span>, Xnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"environment"</span>, <span class="st">"spatial"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-57-1.png" width="480" style="display: block; margin: auto;"></p>
<p>A simpler function <code>varipart</code> is available in
<code>ade4</code> that is able to deal only with two tables of
explanatory variables:</p>
<div class="sourceCode" id="cb145"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vp2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ade4/man/varipart.html" class="external-link">varipart</a></span><span class="op">(</span><span class="va">pca.hell</span><span class="op">$</span><span class="va">tab</span>, <span class="va">mafragh</span><span class="op">$</span><span class="va">env</span>, <span class="va">sel.lw</span><span class="op">$</span><span class="va">best</span><span class="op">$</span><span class="va">MEM.select</span><span class="op">)</span></span>
<span><span class="va">vp2</span></span></code></pre></div>
<pre><code><span><span class="co">## Variation Partitioning</span></span>
<span><span class="co">## class: varipart list </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Test of fractions:</span></span>
<span><span class="co">## class: krandtest lightkrandtest </span></span>
<span><span class="co">## Monte-Carlo tests</span></span>
<span><span class="co">## Call: varipart(Y = pca.hell$tab, X = mafragh$env, W = sel.lw$best$MEM.select)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Number of tests:   3 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Adjustment method for multiple comparisons:   none </span></span>
<span><span class="co">## Permutation number:   999 </span></span>
<span><span class="co">##   Test       Obs   Std.Obs   Alter Pvalue</span></span>
<span><span class="co">## 1   ab 0.2366554  8.166258 greater  0.001</span></span>
<span><span class="co">## 2   bc 0.4665504 15.200387 greater  0.001</span></span>
<span><span class="co">## 3  abc 0.5549152 11.255494 greater  0.001</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Individual fractions:</span></span>
<span><span class="co">##         a         b         c         d </span></span>
<span><span class="co">## 0.0883648 0.1482906 0.3182598 0.4450848 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Adjusted fractions:</span></span>
<span><span class="co">##          a          b          c          d </span></span>
<span><span class="co">## 0.01869906 0.11903282 0.21538309 0.64688504</span></span></code></pre>
<p>Estimates and testing procedures associated to standard variation
partitioning can be biased in the presence of spatial autocorrelation in
both response and explanatory variables. To solve this issue,
<code>adespatial</code> provides functions to perform
spatially-constrained randomization using Moran’s Spectral
Randomization.</p>
</div>
<div class="section level3">
<h3 id="msr">Testing with Moran’s Spectral Randomization<a class="anchor" aria-label="anchor" href="#msr"></a>
</h3>
<p>Moran’s Spectral Randomization (MSR) allows to generate random
replicates that preserve the spatial structure of the original data
<span class="citation">(<a href="#ref-Wagner2015" role="doc-biblioref">Wagner and Dray 2015</a>)</span>. These replicates
can be used to create spatially-constrained null distribution. For
instance, we consider the case of bivariate correlation between
Elevation and Sodium:</p>
<div class="sourceCode" id="cb147"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">$</span><span class="va">env</span><span class="op">[</span>,<span class="fl">10</span><span class="op">]</span>, <span class="va">mafragh</span><span class="op">$</span><span class="va">env</span><span class="op">[</span>,<span class="fl">11</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -0.4033508</span></span></code></pre>
<p>This correlation can be tested by a standard t-test:</p>
<div class="sourceCode" id="cb149"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/cor.test.html" class="external-link">cor.test</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">$</span><span class="va">env</span><span class="op">[</span>,<span class="fl">10</span><span class="op">]</span>, <span class="va">mafragh</span><span class="op">$</span><span class="va">env</span><span class="op">[</span>,<span class="fl">11</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Pearson's product-moment correlation</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## data:  mafragh$env[, 10] and mafragh$env[, 11]</span></span>
<span><span class="co">## t = -4.2964, df = 95, p-value = 4.195e-05</span></span>
<span><span class="co">## alternative hypothesis: true correlation is not equal to 0</span></span>
<span><span class="co">## 95 percent confidence interval:</span></span>
<span><span class="co">##  -0.5579139 -0.2217439</span></span>
<span><span class="co">## sample estimates:</span></span>
<span><span class="co">##        cor </span></span>
<span><span class="co">## -0.4033508</span></span></code></pre>
<p>However this test assumes independence between observations. This
condition is not observed in our data as suggested by the computation of
MC:</p>
<div class="sourceCode" id="cb151"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/moran.randtest.html">moran.randtest</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">$</span><span class="va">env</span><span class="op">[</span>,<span class="fl">10</span><span class="op">]</span>, <span class="va">lw.best</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Monte-Carlo test</span></span>
<span><span class="co">## Call: moran.randtest(x = mafragh$env[, 10], listw = lw.best)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Observation: 0.3833853 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Based on 999 replicates</span></span>
<span><span class="co">## Simulated p-value: 0.001 </span></span>
<span><span class="co">## Alternative hypothesis: greater </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Std.Obs.statistic       Expectation          Variance </span></span>
<span><span class="co">##       4.341745200      -0.007295609       0.008096842</span></span></code></pre>
<p>An alternative is to generate random replicates for the two variables
with same level of spatial autocorrelation:</p>
<div class="sourceCode" id="cb153"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">msr1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msr.html">msr</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">$</span><span class="va">env</span><span class="op">[</span>,<span class="fl">10</span><span class="op">]</span>, <span class="va">lw.best</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/moran.randtest.html">moran.randtest</a></span><span class="op">(</span><span class="va">msr1</span>, <span class="va">lw.best</span>, nrepet <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">$</span><span class="va">obs</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">##  0.3682  0.3776  0.3818  0.3818  0.3863  0.3940</span></span></code></pre>
<div class="sourceCode" id="cb155"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">msr2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msr.html">msr</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">$</span><span class="va">env</span><span class="op">[</span>,<span class="fl">11</span><span class="op">]</span>, <span class="va">lw.best</span><span class="op">)</span></span></code></pre></div>
<p>Then, the statistic is computed on observed and simulated data to
build a randomization test:</p>
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">mafragh</span><span class="op">$</span><span class="va">env</span><span class="op">[</span>,<span class="fl">10</span><span class="op">]</span>, <span class="va">mafragh</span><span class="op">$</span><span class="va">env</span><span class="op">[</span>,<span class="fl">11</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">msr1</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">msr1</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span>, <span class="va">msr2</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">testmsr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ade4/man/randtest.html" class="external-link">as.randtest</a></span><span class="op">(</span>obs <span class="op">=</span> <span class="va">obs</span>, sim <span class="op">=</span> <span class="va">sim</span>, alter <span class="op">=</span> <span class="st">"two-sided"</span><span class="op">)</span></span>
<span><span class="va">testmsr</span></span></code></pre></div>
<pre><code><span><span class="co">## Monte-Carlo test</span></span>
<span><span class="co">## Call: as.randtest(sim = sim, obs = obs, alter = "two-sided")</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Observation: -0.4033508 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Based on 99 replicates</span></span>
<span><span class="co">## Simulated p-value: 0.01 </span></span>
<span><span class="co">## Alternative hypothesis: two-sided </span></span>
<span><span class="co">## </span></span>
<span><span class="co">##      Std.Obs  Expectation     Variance </span></span>
<span><span class="co">## -2.595386551 -0.002832713  0.023814423</span></span></code></pre>
<p>The function <code>msr</code> is generic and several methods are
implemented in <code>adespatial</code>. For instance, it can be used to
correct estimates and significance of the environmental fraction in the
case of a variation partitioning <span class="citation">(<a href="#ref-Clappe2018" role="doc-biblioref">Clappe, Dray, and Peres-Neto
2018</a>)</span> computed with the <code>varipart</code> function:</p>
<div class="sourceCode" id="cb158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/msr.html">msr</a></span><span class="op">(</span><span class="va">vp2</span>, listwORorthobasis <span class="op">=</span> <span class="va">lw.best</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Variation Partitioning</span></span>
<span><span class="co">## class: varipart list </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Test of fractions:</span></span>
<span><span class="co">## Monte-Carlo test</span></span>
<span><span class="co">## Call: msr.varipart(x = vp2, listwORorthobasis = lw.best)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Observation: 0.2366554 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Based on 999 replicates</span></span>
<span><span class="co">## Simulated p-value: 0.001 </span></span>
<span><span class="co">## Alternative hypothesis: greater </span></span>
<span><span class="co">## </span></span>
<span><span class="co">##      Std.Obs  Expectation     Variance </span></span>
<span><span class="co">## 3.9356903225 0.1533142507 0.0004484117 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Individual fractions:</span></span>
<span><span class="co">##         a         b         c         d </span></span>
<span><span class="co">## 0.0883648 0.1482906 0.3182598 0.4450848 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Adjusted fractions:</span></span>
<span><span class="co">##          a          b          c          d </span></span>
<span><span class="co">## 0.01070405 0.08772814 0.24668776 0.65488004</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Bauman2018" class="csl-entry">
Bauman, D, T Drouet, S Dray, and J Vleminckx. 2018. <span>“<span class="nocase">Disentangling good from bad practices in the selection of
spatial or phylogenetic eigenvectors</span>.”</span> <em>Ecography</em>
41: 1638–49.
</div>
<div id="ref-Bauman2018a" class="csl-entry">
Bauman, D, T Drouet, M J Fortin, and S Dray. 2018. <span>“<span class="nocase">Optimizing the choice of a spatial weighting matrix in
eigenvector-based methods</span>.”</span> <em>Ecology</em> 99 (10):
2159–66.
</div>
<div id="ref-Borcard2002" class="csl-entry">
Borcard, D, and P Legendre. 2002. <span>“<span class="nocase">All-scale
spatial analysis of ecological data by means of principal coordinates of
neighbour matrices</span>.”</span> <em>Ecological Modelling</em> 153:
51–68.
</div>
<div id="ref-Borcard1992" class="csl-entry">
Borcard, D, P Legendre, and P Drapeau. 1992. <span>“<span class="nocase">Partialling out the spatial component of ecological
variation</span>.”</span> <em>Ecology</em> 73 (3): 1045–55.
</div>
<div id="ref-Clappe2018" class="csl-entry">
Clappe, S, S Dray, and P R Peres-Neto. 2018. <span>“<span class="nocase">Beyond neutrality: disentangling the effects of species
sorting and spurious correlations in community analysis</span>.”</span>
<em>Ecology</em> 99 (8): 1737–47.
</div>
<div id="ref-Dray2011" class="csl-entry">
Dray, S. 2011. <span>“<span class="nocase">A new perspective about
Moran’s coefficient: spatial autocorrelation as a linear regression
problem</span>.”</span> <em>Geographical Analysis</em> 43: 127–41.
</div>
<div id="ref-Dray2007" class="csl-entry">
Dray, S, and A B Dufour. 2007. <span>“<span class="nocase">The ade4
package: implementing the duality diagram for ecologists</span>.”</span>
<em>Journal of Statistical Software</em> 22 (4): 1–20.
</div>
<div id="ref-Dray2006" class="csl-entry">
Dray, S, P Legendre, and P R Peres-Neto. 2006. <span>“<span class="nocase">Spatial modeling: a comprehensive framework for principal
coordinate analysis of neighbor matrices (PCNM)</span>.”</span>
<em>Ecological Modelling</em> 196: 483–93.
</div>
<div id="ref-Dray2012" class="csl-entry">
Dray, S, R Pélissier, P Couteron, M J Fortin, P Legendre, P R
Peres-Neto, E Bellier, et al. 2012. <span>“<span class="nocase">Community ecology in the age of multivariate multiscale
spatial analysis</span>.”</span> <em>Ecological Monographs</em> 82 (3):
257–75.
</div>
<div id="ref-Dray2008" class="csl-entry">
Dray, S, S Saïd, and F Débias. 2008. <span>“<span class="nocase">Spatial
ordination of vegetation data using a generalization of Wartenberg’s
multivariate spatial correlation</span>.”</span> <em>Journal of
Vegetation Science</em> 19: 45–56.
</div>
<div id="ref-Griffith1996" class="csl-entry">
Griffith, D A. 1996. <span>“<span class="nocase">Spatial autocorrelation
and eigenfunctions of the geographic weights matrix accompanying
geo-referenced data</span>.”</span> <em>Canadian Geographer</em> 40 (4):
351–67.
</div>
<div id="ref-Jombart2009" class="csl-entry">
Jombart, T, S Dray, and A B Dufour. 2009. <span>“<span class="nocase">Finding essential scales of spatial variation in
ecological data: a multivariate approach</span>.”</span>
<em>Ecography</em> 32: 161–68.
</div>
<div id="ref-Peres-Neto2006a" class="csl-entry">
Peres-Neto, P R, P Legendre, S Dray, and D Borcard. 2006. <span>“<span class="nocase">Variation partitioning of species data matrices:
estimation and comparison of fractions</span>.”</span> <em>Ecology</em>
87: 2614–25.
</div>
<div id="ref-Siberchicot2017" class="csl-entry">
Siberchicot, A, A Julien-Laferrière, A B Dufour, J Thioulouse, and S
Dray. 2017. <span>“<span class="nocase">adegraphics: An S4 lattice-based
package for the representation of multivariate data</span>.”</span>
<em>R Journal</em> 9 (2).
</div>
<div id="ref-Wagner2015" class="csl-entry">
Wagner, H H, and S Dray. 2015. <span>“<span class="nocase">Generating
spatially constrained null models for irregularly spaced data using
Moran spectral randomization methods</span>.”</span> <em>Methods in
Ecology and Evolution</em> 6 (10): 1169–78.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Stéphane Dray, Aurélie Siberchicot.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
